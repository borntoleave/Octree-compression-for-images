Final version with everything all right.
The problem was I used 256^2 instead of pow(256,2) when assigning idex to the colors.